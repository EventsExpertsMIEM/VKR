<!DOCTYPE html>
<html lang="en">

<head>

    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <meta name="description" content="">
    <meta name="author" content="">
    <link rel="shortcut icon" href="img/favicon_circle.png">
    <title>SETUP</title>

    <!-- Bootstrap core CSS -->
    <link href="vendor/bootstrap/css/bootstrap.min.css" rel="stylesheet">

    <!-- Custom fonts for this template -->
    <link href="https://fonts.googleapis.com/css?family=Saira+Extra+Condensed:500,700" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css?family=Muli:400,400i,800,800i" rel="stylesheet">
    <link href="vendor/fontawesome-free/css/all.min.css" rel="stylesheet">

    <!-- Custom styles for this template -->
    <link href="css/resume.min.css" rel="stylesheet">

    <link
        rel="stylesheet"
        href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.0.3/styles/atom-one-dark.min.css">
    <script
        src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.0.0/highlight.min.js">
    </script>

</head>

<body id="page-top">

    <nav class="navbar navbar-expand-lg navbar-dark bg-primary fixed-top" id="sideNav">
        <a class="navbar-brand js-scroll-trigger" href="#page-top">
            <span class="d-block d-lg-none">Events Project</span>
            <span class="d-none d-lg-block">
                <img class="img-fluid img-profile rounded-circle border-0 mx-auto w-50" src="img/logo.jpg" alt="">
            </span>
        </a>
        <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarSupportedContent"
            aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
            <span class="navbar-toggler-icon"></span>
        </button>
        <div class="collapse navbar-collapse" id="navbarSupportedContent">
            <ul class="navbar-nav">
                <li class="nav-item">
                    <a class="nav-link" href="index.html">Home</a>
                </li>
                <li class="nav-item">
                    <a class="nav-link js-scroll-trigger" href="#db">DB</a>
                </li>
                <li class="nav-item">
                    <a class="nav-link js-scroll-trigger" href="#install">Code</a>
                </li>
                <li class="nav-item">
                    <a class="nav-link js-scroll-trigger" href="#setup">config</a>
                </li>
                <li class="nav-item">
                    <a class="nav-link js-scroll-trigger" href="#nginx-config">NGINX</a>
                </li>
                <li class="nav-item">
                    <a class="nav-link js-scroll-trigger" href="#usage">Running</a>
                </li>
            </ul>
        </div>
    </nav>

    <div class="container-fluid p-0">

        <section class="resume-section p-3 p-lg-5 d-flex align-items-center" id="db">
            <div class="w-100">
                <h2 class="mb-5">DB setup</h2>

                <p>Почему PostgreSQL:</p>
                <ul class="list-group-flush">
                    <li>Хорошая докумантция и большое сообщество.</li>
                    <li>Поддержка множества дополнительных типов, например UUID, JSONB и другие.</li>
                    <li>Следует ACID (в отличии от MySQL/InnoDB).</li>
                    <li>Шардирование из коробки.</li>
                </ul>

                <p>Можно поднять PostgreSQL в облаке (например <a href="https://www.heroku.com/">Heroku</a>) или же
                    развернуть на своих ресурсах по инструкции ниже:</p>

                <p>1) Ставим пакет:</p>
                <ul class="list-group-flush">
                    <li>Ubuntu:</li>
                    <pre><kbd>sudo apt install -y postgresql</kbd></pre>
                    <li>CentOS 7:</li>
                    <pre><kbd>sudo yum install postgresql-server postgresql-contrib</kbd></pre>
                    <pre><kbd>sudo postgresql-setup initdb</kbd></pre>
                    <pre><kbd>sudo systemctl start postgresql</kbd></pre>
                    <li>Windows:</li>
                    <pre><code>Скачать с сайта и установить.</code></pre>
                </ul>
                <p></p>
                <p>2) Переходим в суперюзера бд:</p>
                <ul class="list-group-flush">
                    <li>Linux:</li>
                    <pre><kbd>sudo su - postgres</kbd></pre>
                    <li>Windows:</li>
                    <pre><code>Залогиниться через консоль в админа постгреса.</code></pre>
                </ul>
                <p></p>
                <p>3) Создаём новую роль:</p>
                <pre><kbd>createuser %usename% --pwprompt</kbd></pre>
                <p></p>
                <p>4) Создаём саму БД:</p>
                <pre><kbd>createdb -O %username% %dbname%</kbd></pre>
                <p></p>
                <p>5) Подключаемся к новой БД и даем доступы:</p>
                <pre><kbd>psql %dbname% </kbd></pre>
                <pre><kbd>GRANT ALL ON DATABASE %dbname% to %username%;</kbd></pre>
                <p></p>
                <p>6) CENTOS ONLY! Отредактировать конфиг-файл:</p>
                <pre><kbd>cd /var/lib/pgsql/data/</kbd></pre>
                <pre><kbd>sudo nano/vim ph_hba.conf</kbd></pre>
                <pre><code>Заменить METHOD на md5 у local, ipv4, ipv6 connections (3 записи).</code></pre>
            </div>
        </section>

        <hr class="m-0">

        <section class="resume-section p-3 p-lg-5 d-flex align-items-center" id="install">
            <div class="w-100">
                <h2 class="mb-5">Install (need to write windows ver)</h2>

                <p>В первую очередь ставим нужные пакеты (Ubuntu):</p>
                <pre><kbd>sudo apt install git python python3 python3-pip</kbd></pre>
                <pre><kbd>pip3 install virtualenv</kbd></pre>
                <p></p>
                <p>Клонинуем репозиторий и настраиваем виртуальное (опционально для продакшн-сервера) окружение
                    (bash/zsh):</p>
                <pre><kbd>git clone git@github.com:EventsExpertsMIEM/backend_19288.git</kbd></pre>
                <pre><kbd>python3 -m virtualenv venv</kbd></pre>
                <pre><kbd>. venv/bin/activate</kbd></pre>
                <p></p>
                <p>Ставим зависимости проекта</p>
                <pre><kbd>pip3 install -r requirements.txt</kbd></pre>
            </div>
        </section>

        <hr class="m-0">

        <section class="resume-section p-3 p-lg-5 d-flex align-items-center" id="setup">
            <div class="w-100">
                <h2 class="mb-5">SETUP</h2>

                <p>Данный скрипт заполняет конфиг из переменных окружения, и его рекомендуется положить заполненный вне папки репозитория.</p>
                <p>// Пустые шаблоны также доступны в корне репозитория.</p>

                <div class="row">
                    <div class="col-lg-6">
                        <p class="font-weight-bold">Ubuntu</p>
                    </div>
                    <div class="col-lg-6">
                        <p class="font-weight-bold">Windows</p>
                    </div>
                </div>

                <div class="row">
                    <div class="col-lg-6">
                        <div><kbd>#!/bin/bash</kbd></div>
                        <p></p>
                    </div>
                </div>
                <code># пользователь postgresql</code>
                <div class="row">
                    <div class="col-lg-6">
                        <div><kbd>export PGUSER=""</kbd></div>
                    </div>
                    <div class="col-lg-6">
                        <div><kbd>set PGUSER=</kbd></div>
                    </div>
                </div>
                <code># адрес postgresql</code>
                <div class="row">
                    <div class="col-lg-6">
                        <div><kbd>export PGHOST=""</kbd></div>
                    </div>
                    <div class="col-lg-6">
                        <div><kbd>set PGHOST=</kbd></div>
                    </div>
                </div>
                <code># порт postgresql</code>
                <div class="row">
                    <div class="col-lg-6">
                        <div><kbd>export PGPORT=""</kbd></div>
                    </div>
                    <div class="col-lg-6">
                        <div><kbd>set PGPORT=</kbd></div>
                    </div>
                </div>
                <code># название БД в postgresql</code>
                <div class="row">
                    <div class="col-lg-6">
                        <div><kbd>export PGDATABASE=""</kbd></div>
                    </div>
                    <div class="col-lg-6">
                        <div><kbd>set PGDATABASE=</kbd></div>
                    </div>
                </div>
                <code># пароль пользователя postgresql</code>
                <div class="row">
                    <div class="col-lg-6">
                        <div><kbd>export PGPASSWORD=""</kbd></div>
                    </div>
                    <div class="col-lg-6">
                        <div><kbd>set PGPASSWORD=</kbd></div>
                    </div>
                </div>
                <p></p>
                <code># порт приложения</code>
                <div class="row">
                    <div class="col-lg-6">
                        <div><kbd>export PORT=""</kbd></div>
                    </div>
                    <div class="col-lg-6">
                        <div><kbd>set PORT=</kbd></div>
                    </div>
                </div><br><br>

                <code>
                    # Настройки TLS<br><br>
                    # Для активации TLS необходимо<br>
                    # установить переменные SSL_ENABLED, SSL_CERT и SSL_KEY<br><br>
                    # Активирует TLS, True/False
                </code>
                <div class="row">
                    <div class="col-lg-6">
                        <div><kbd>export SSL_ENABLED=""</kbd></div>
                    </div>
                    <div class="col-lg-6">
                        <div><kbd>set SSL_ENABLED=</kbd></div>
                    </div>
                </div><br>

                <code># Путь к файлу сертификата</code>
                <div class="row">
                    <div class="col-lg-6">
                        <div>
                            <kbd>export SSL_CERT=""</kbd>
                        </div>
                    </div>
                    <div class="col-lg-6">
                        <div>
                            <kbd>set SSL_CERT=</kbd>
                        </div>
                    </div>
                </div><br>

                <code># Путь к файлу приватного ключа сертификата</code>
                <div class="row">
                    <div class="col-lg-6">
                        <div><kbd>export SSL_KEY=""</kbd></div>
                    </div>
                    <div class="col-lg-6">
                        <div><kbd>set SSL_KEY=</kbd></div>
                    </div>
                </div><br><br>

                <code># почта супер-администратора</code>
                <div class="row">
                    <div class="col-lg-6">
                        <div><kbd>export SUPER_ADMIN_MAIL=""</kbd></div>
                    </div>
                    <div class="col-lg-6">
                        <div><kbd>set SUPER_ADMIN_MAIL=</kbd></div>
                    </div>
                </div>
                <code># пароль от аккаунта супер-админа</code>
                <div class="row">
                    <div class="col-lg-6">
                        <div><kbd>export SUPER_ADMIN_PASSWORD=""</kbd></div>
                    </div>
                    <div class="col-lg-6">
                        <div><kbd>set SUPER_ADMIN_PASSWORD=</kbd></div>
                    </div>
                </div>
                <div><code># подтверждение регистрации по электронной почте</code></div>
                <div><code># 'active' (account_status) для отключения подтверждения</code></div>
                <div><code># 'unconfirmed' (account_status) для включения</code></div>
                <div class="row">
                    <div class="col-lg-6">
                        <div><kbd>export DEFAULT_USER_STATUS=""</kbd></div>
                    </div>
                    <div class="col-lg-6">
                        <div><kbd>set DEFAULT_USER_STATUS=</kbd></div>
                    </div>
                </div>
                <p></p>
                <code># временно - линк на сервис (http(s)://адрес:порт)</code>
                <div class="row">
                    <div class="col-lg-6">
                        <div><kbd>export SITE_ADDR=""</kbd></div>
                    </div>
                    <div class="col-lg-6">
                        <div><kbd>set SITE_ADDR=</kbd></div>
                    </div>
                </div>
                <p></p>
                <code># Уровень логгирования</code>
                <div class="row">
                    <div class="col-lg-6">
                        <div><kbd>export LOG_LEVEL=</kbd></div>
                    </div>
                    <div class="col-lg-6">
                        <div><kbd>set LOG_LEVEL=</kbd></div>
                    </div>
                </div>
                <code># Отключать ли сторонние логгеры (True, False)</code>
                <div class="row">
                    <div class="col-lg-6">
                        <div><kbd>export DISABLE_EXISTING_LOGGERS=</kbd></div>
                    </div>
                    <div class="col-lg-6">
                        <div><kbd>set DISABLE_EXISTING_LOGGERS=</kbd></div>
                    </div>
                </div>
                <p></p>
                <code># SMTP сервер</code>
                <div class="row">
                    <div class="col-lg-6">
                        <div><kbd>export MAIL_SERVER=""</kbd></div>
                    </div>
                    <div class="col-lg-6">
                        <div><kbd>set MAIL_SERVER=</kbd></div>
                    </div>
                </div>
                <code># Порт на почтовом сервере</code>
                <div class="row">
                    <div class="col-lg-6">
                        <div><kbd>export MAIL_PORT=</kbd></div>
                    </div>
                    <div class="col-lg-6">
                        <div><kbd>set MAIL_PORT=</kbd></div>
                    </div>
                </div>
                <code># Логин для почтового сервера</code>
                <div class="row">
                    <div class="col-lg-6">
                        <div><kbd>export MAIL_USERNAME=""</kbd></div>
                    </div>
                    <div class="col-lg-6">
                        <div><kbd>set MAIL_USERNAME=</kbd></div>
                    </div>
                </div>
                <code># Пароль от почтового сервера</code>
                <div class="row">
                    <div class="col-lg-6">
                        <div><kbd>export MAIL_PASSWORD=""</kbd></div>
                    </div>
                    <div class="col-lg-6">
                        <div><kbd>set MAIL_PASSWORD=</kbd></div>
                    </div>
                </div>
                <code># Адрес, который будет указан в поле From</code>
                <div class="row">
                    <div class="col-lg-6">
                        <div><kbd>export MAIL_DEFAULT_SENDER="noreply@$SITE_ADDR"</kbd></div>
                    </div>
                    <div class="col-lg-6">
                        <div><kbd>set MAIL_DEFAULT_SENDER=</kbd></div>
                    </div>
                </div>
            </div>
        </section>

        <hr class="m-0">

        <section
        id="nginx-config"
        class="resume-section p-3 p-lg-5 d-flex align-items-center">
        <div class="w-100">
            <h2 class="mb-5">Nginx</h2>
            <p>Ниже представлен шаблон nginx конфига для работы с сервисом.</p>
            <pre><code class="nginxconf" id="nginx-config-text">
server {

    # Прокси сервер открывается на стандортном порту для HTTP трафика, но для дополнительной безопасности
    # включено обязательное шифрование с помощью директивы ssl
    listen 80 ssl;

    # %domain-name% - домен, на котором будет работать приложение
    server_name %domain-name%;

    # Пути, по которым находятся TLS сертификат и приватный ключ от него
    # - %certificate%.crt - Файл сертификата
    # - %certificate_private_key%.key - Приватный ключ сертификата
    # В качестве примера приведены стандартные пути размещения для сертификатов и ключей в CentOS 7
    ssl_certificate /etc/pki/tls/certs/%certificate%.crt;
    ssl_certificate_key /etc/pki/tls/private/%certificate_private_key%.key;

    # При попытке подключится к HTTPS серверу посредством HTTP возникнет ошибка под номером 497
    # Данная директива указывает серверу на то, что при возникновении ошибки 497
    # нобходимо произвести переподключение с использованием протокола HTTPS
    error_page 497 301 =307 https://$http_host$uri;

    # Настройка проксирования запросов
    # Директива location / говорит о необходимости перенаправлять все запросы 
    location / {
        # Необходимо установить заголовок Host включающий в себя полный запрос,
        # так как по умолчанию в заголовке Host не учитывается номер порта, на который пришел запрос
        # что приводит к некорректному формированию редирктов
        proxy_set_header Host $http_host;

        # Директива proxy_pass устанавливает адрес, на который необходимо перенаправлять запросы
        # - %ip% - ip адресс бекэнд сервера
        # - %port% - порт, на котором работает бекэнд сервер
        # Для обеспечения дополнительной безопасности рекомендуется запускать бекэнд сервер
        # с включенной поддержкой TLS. В случае, если бекэнд запущен без использования TLS
        # в директиве proxy_pass необходимо заменить https на http
        proxy_pass https://%ip%:%port%/;
    }
}
</code></pre>
            <p></p>
        </div>
    </section>

    <hr class="m-0">

        <section class="resume-section p-3 p-lg-5 d-flex align-items-center" id="usage">
            <div class="w-100">
                <h2 class="mb-5">Running</h2>
                <p>Сервис берёт свои настройки (БД, параметры почты и др.) через переменные окружения, поэтому
                    рекомендуется использовать специальный скрипт (например <a class="js-scroll-trigger"
                        href="#setup">setup.sh/setup.bat</a>) и инициилизировать переменные окручения через <kbd>.
                        setup.sh</kbd> / <kbd>source setup.sh</kbd> / <kbd>setup.bat</kbd>.</p>
                <p></p>
                <p>При первом запуске необходимо указать <kbd>--create-tables</kbd>, чтобы создать в БД нужные таблицы
                    (или сбросить, если необходим перезапуск с очисткой)</p>
                <p></p>
                <p>Запуск происходит через <kbd>python3 main.py</kbd>.</p>
            </div>
        </section>

    </div>

    <!-- Bootstrap core JavaScript -->
    <script src="vendor/jquery/jquery.min.js"></script>
    <script src="vendor/bootstrap/js/bootstrap.bundle.min.js"></script>

    <!-- Plugin JavaScript -->
    <script src="vendor/jquery-easing/jquery.easing.min.js"></script>

    <!-- Custom scripts for this template -->
    <script src="js/resume.min.js"></script>

    <script>
        hljs.highlightBlock(document.getElementById('nginx-config-text'));
    </script>

</body>

</html>